{% set idprefix = ["V-driving-force-", idsuffix] | join %}
<figure class="demo-container" style="max-width: 200px">
    <div style="display: flex; gap: 8px">
        <div
            id="{{ idprefix }}-container"
            style="
                flex: 1;
                height: 200px;
                min-width: 120px;
                border: 1px solid #eee;
            "
        ></div>
    </div>
    <div style="text-align: center">
        <div>
            <label for="{{ idprefix }}-slider" style="font-size: 0.85em"
                >Electric offset on body 2:</label
            >
            <br />
            <input
                type="range"
                id="{{ idprefix }}-slider"
                list="{{ idprefix }}-slider-datalist"
                min="-0.5"
                max="0.5"
                step="any"
                value="0.0"
                style="width: 100px"
            />
            <datalist id="{{ idprefix }}-slider-datalist">
                <option value="0" label="0">0</option>
            </datalist>
        </div>
    </div>
</figure>

<script type="module">
    import EnergyLevelsDiagram from '{{ esbdJsPath }}EnergyLevelsDiagram.js';
    import { throttle } from '{{ esbdJsPath }}utils.js';

    const slider = document.getElementById('{{ idprefix }}-slider');
    const containerId = '{{ idprefix }}-container';
    const diagramContainer = document.getElementById(containerId);

    if (
        !(
            slider &&
            diagramContainer &&
            typeof EnergyLevelsDiagram !== 'undefined'
        )
    ) {
        throw 'Could not find all elements for chemical potential driving force demo.';
    }

    // --- Configuration ---
    const config = {
        yAxisLabel: 'Voltage',
        yRange: [-1.5, 1.5], // Adjust based on base + max diff
        showYTicks: false,
        categories: [
            { id: 'body1', label: 'Body 1' },
            { id: 'body2', label: 'Body 2' },
        ],
        defaultLevelStyle: { lineWidth: 2 },
    };
    const throttleDuration = 100; // should be 1/5 or less of above

    // --- Instantiate ---
    let diagram = null;
    try {
        diagram = new EnergyLevelsDiagram(containerId, config);
    } catch (e) {
        diagramContainer.innerHTML =
            "<p style='color:red;'>Error loading diagram.</p>";
        throw e;
    }

    // --- Update Function ---
    function updateDemo(deltaV) {
        if (!diagram) return;

        const Ve1 = 0.8;
        const Ve2 = 0.7 + deltaV;
        const Vli1 = -0.4;
        const Vli2 = 0.0 + deltaV;
        const Vphi1 = 0.1;
        const Vphi2 = -0.5 + deltaV;

        // 1. Update Levels
        const levelsData = [
            {
                categoryId: 'body1',
                levelId: 'Ve1',
                yValue: Ve1,
                label: 'V_{\\mathrm{e}^-}',
                color: '#377eb8',
            },
            {
                categoryId: 'body2',
                levelId: 'Ve2',
                yValue: Ve2,
                label: 'V_{\\mathrm{e}^-}',
                color: '#377eb8',
            },
            {
                categoryId: 'body1',
                levelId: 'Vli1',
                yValue: Vli1,
                label: 'V_{\\mathrm{Li}^+}',
                color: '#e41a1c',
            },
            {
                categoryId: 'body2',
                levelId: 'Vli2',
                yValue: Vli2,
                label: 'V_{\\mathrm{Li}^+}',
                color: '#e41a1c',
            },
            {
                categoryId: 'body1',
                levelId: 'Vphi1',
                yValue: Vphi1,
                label: '\\phi',
                color: '#222',
            },
            {
                categoryId: 'body2',
                levelId: 'Vphi2',
                yValue: Vphi2,
                label: '\\phi',
                color: '#222',
            },
        ];
        diagram.setLevels(levelsData);

        // 2. Update Arrow based on difference
        let arrowData = [];
        const dVe = Ve2 - Ve1;
        if (Math.abs(dVe) > 0.01) {
            // Only draw arrow if there's a difference
            const isFlow1to2 = dVe < 0; // V1 > V2
            arrowData.push({
                arrowId: 'flow_e',
                fromLevelId: isFlow1to2 ? 'Ve1' : 'Ve2',
                toLevelId: isFlow1to2 ? 'Ve2' : 'Ve1',
                label: '\\text{Charge flow}', // Always label flow direction
                arrowStyle: '->', // Always point high to low
                color: '#4daf4a', // Green for flow?
            });
        }
        const dVli = Vli2 - Vli1;
        if (Math.abs(dVli) > 0.01) {
            // Only draw arrow if there's a difference
            const isFlow1to2 = dVli < 0; // V1 > V2
            arrowData.push({
                arrowId: 'flow_li',
                fromLevelId: isFlow1to2 ? 'Vli1' : 'Vli2',
                toLevelId: isFlow1to2 ? 'Vli2' : 'Vli1',
                label: '\\text{Charge flow}', // Always label flow direction
                arrowStyle: '->', // Always point high to low
                color: '#4daf4a', // Green for flow?
            });
        }
        diagram.setArrows(arrowData);
    }

    // --- Event Listener ---
    slider.addEventListener(
        'input',
        throttle((event) => {
            const deltaV = parseFloat(event.target.value);
            updateDemo(deltaV);
        }, throttleDuration)
    );

    // --- Initial Draw ---
    updateDemo(parseFloat(slider.value));
</script>
