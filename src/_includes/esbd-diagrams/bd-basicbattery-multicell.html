{% set idprefix = ["bd-basicbattery-multicell-", idsuffix] | join %}
<figure class="demo-container" style="max-width: 300px">
    <div class="bd-container" id="{{ idprefix }}"></div>
    <div style="text-align: center">
        <div>
            <label for="{{ idprefix }}-current-slider" style="font-size: 0.85em"
                >Current (<b
                    ><span id="{{ idprefix }}-current-text"
                        >equilibrium</span
                    ></b
                >):</label
            >
            <br />
            <input
                type="range"
                id="{{ idprefix }}-current-slider"
                list="{{ idprefix }}-current-slider-datalist"
                min="-1"
                max="1"
                step="any"
                value="0.0"
                style="width: 100px"
            />
            <datalist id="{{ idprefix }}-current-slider-datalist">
                <option value="0" label="0">0</option>
            </datalist>
        </div>
    </div>
</figure>

<script type="module">
    const plotContainerId = '{{ idprefix }}';
    const currentSliderId = '{{ idprefix }}-current-slider';
    const currentTextId = '{{ idprefix }}-current-text';

    import BandDiagram from '{{ esbdJsPath }}BandDiagram.js';
    import { throttle } from '{{ esbdJsPath }}utils.js';

    const throttleDuration = 100; // should be 1/5 or less of transitionDuration

    const diagram = new BandDiagram(plotContainerId);
    const currentSlider = document.getElementById(currentSliderId);
    const currentText = document.getElementById(currentTextId);

    // Set layout
    const cellregions = [
        [0.15, { name: 'Anode', color: '#AAAAAA' }],
        [0.3, { name: 'Anode-active', color: '#bbb' }],
        [0.7, { name: 'Electrolyte', color: '#E6F5FF' }],
        [0.85, { name: 'Cathode-active', color: '#bbb' }],
        [1.0, { name: 'Cathode', color: '#AAAAAA' }],
    ];

    const boundaries = [0.0];
    const regions = [];
    const labels = [];
    for (let cellidx = 0; cellidx < 3; cellidx++) {
        cellregions.forEach((element) => {
            const [xright, region] = element;
            boundaries.push(xright + cellidx);
            regions.push(region);
        });
        labels.push({ label: `Cell ${cellidx + 1}`, x: 0.5 + cellidx });
    }
    diagram.setSpatialLayout(boundaries, regions, labels);

    diagram.setYLabel('Species voltage (V)');
    diagram.setYRange(-1.5, +11.2);

    const R_anode = 0.03;
    const R_cathode = R_anode;
    const R_Li = 0.2;
    const OCV_anode = 0.1;
    const OCV_cathode = 3.4;

    const li_color = '#E41A1C';
    const electron_color = '#377EB8';

    function updateDiagrams() {
        const dphi = 0;
        const current = parseFloat(currentSlider.value);

        if (current > 0) {
            currentText.textContent = 'discharging⇨';
        } else if (current < 0) {
            currentText.textContent = '⇦charging';
        } else {
            currentText.textContent = 'equilibrium';
        }

        const V_left = 0.0 + dphi;
        const V_Li_left = V_left - OCV_anode;
        const V_Li_right = V_Li_left - current * R_Li;
        const V_right = V_Li_right + OCV_cathode;
        const V_anode = V_left - current * R_anode;
        const V_cathode = V_right + current * R_cathode;
        const V_cell = V_right - V_left;

        const b = boundaries;
        const bn = cellregions.length;
        const data = [];
        for (let cellidx = 0; cellidx < 3; cellidx++) {
            const b0 = cellregions.length * cellidx;
            const V0 = V_cell * cellidx;
            data.push({
                id: 'anode_trace_' + cellidx,
                label: 'V_{\\mathrm{e}^-}',
                showLabel: false,
                color: electron_color,
                x: [b[b0 + 0], b[b0 + 1], b[b0 + 2]],
                y: [V0 + V_left, V0 + V_left, V0 + V_anode],
            });
            data.push({
                id: 'li_trace_' + cellidx,
                label: 'V_{\\mathrm{Li}^+}',
                showLabel: true,
                color: li_color,
                x: [b[b0 + 1], b[b0 + 4]],
                y: [V0 + V_Li_left, V0 + V_Li_right],
            });
            data.push({
                id: 'cathode_trace_' + cellidx,
                label: 'V_{\\mathrm{e}^-}',
                showLabel: cellidx == 2,
                color: electron_color,
                x: [b[b0 + 3], b[b0 + 4], b[b0 + 5]],
                y: [V0 + V_cathode, V0 + V_right, V0 + V_right],
            });
        }
        diagram.updateTraceData(data);
    }

    // Slider event listeners - throttle them.
    const updateThrottler = throttle(
        (event) => updateDiagrams(),
        throttleDuration
    );
    currentSlider.addEventListener('input', updateThrottler);

    updateDiagrams();
</script>
