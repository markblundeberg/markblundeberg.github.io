{% set idprefix = ["V-driving-force-", idsuffix] | join %}
<figure class="demo-container" style="max-width: 200px">
    <div style="display: flex; gap: 8px">
        <div
            id="{{ idprefix }}-container"
            style="
                flex: 1;
                height: 200px;
                min-width: 120px;
                border: 1px solid #eee;
            "
        ></div>
    </div>
    <div style="text-align: center">
        <div>
            <label for="{{ idprefix }}-slider" style="font-size: 0.85em"
                >$V_i$ difference:</label
            >
            <br />
            <input
                type="range"
                id="{{ idprefix }}-slider"
                list="{{ idprefix }}-slider-datalist"
                min="-2.0"
                max="2.0"
                step="any"
                value="1.0"
                style="width: 100px"
            />
            <datalist id="{{ idprefix }}-slider-datalist">
                <option value="0" label="0">0</option>
            </datalist>
        </div>
    </div>
</figure>

<script type="module">
    import EnergyLevelsDiagram from '{{ esbdJsPath }}EnergyLevelsDiagram.js';
    import { throttle } from '{{ esbdJsPath }}utils.js';

    const slider = document.getElementById('{{ idprefix }}-slider');
    const containerId = '{{ idprefix }}-container';
    const diagramContainer = document.getElementById(containerId);

    if (
        !(
            slider &&
            diagramContainer &&
            typeof EnergyLevelsDiagram !== 'undefined'
        )
    ) {
        throw 'Could not find all elements for chemical potential driving force demo.';
    }

    // --- Configuration ---
    const config = {
        yAxisLabel: 'Voltage $V_i$',
        yRange: [-1.5, 1.5], // Adjust based on base + max diff
        showYTicks: false,
        categories: [
            { id: 'body1', label: 'Body 1' },
            { id: 'body2', label: 'Body 2' },
        ],
        defaultLevelStyle: { lineWidth: 2 },
    };
    const throttleDuration = 100; // should be 1/5 or less of above

    // --- Instantiate ---
    let diagram = null;
    try {
        diagram = new EnergyLevelsDiagram(containerId, config);
    } catch (e) {
        diagramContainer.innerHTML =
            "<p style='color:red;'>Error loading diagram.</p>";
        throw e;
    }

    // --- Update Function ---
    function updateDemo(deltaV) {
        if (!diagram) return;

        const V_base = 0; // Center levels around 0 for simplicity
        const V1 = V_base + deltaV / 2;
        const V2 = V_base - deltaV / 2;

        // 1. Update Levels
        const levelsData = [
            {
                categoryId: 'body1',
                levelId: 'V1',
                yValue: V1,
                label: 'V_i',
                color: '#377eb8',
            }, // Blue
            {
                categoryId: 'body2',
                levelId: 'V2',
                yValue: V2,
                label: 'V_i',
                color: '#e41a1c',
            }, // Red
        ];
        diagram.setLevels(levelsData);

        // 2. Update Arrow based on difference
        let arrowData = [];
        if (Math.abs(deltaV) > 0.01) {
            // Only draw arrow if there's a difference
            const isFlow1to2 = deltaV > 0; // V1 > V2
            arrowData.push({
                arrowId: 'flow',
                fromLevelId: isFlow1to2 ? 'V1' : 'V2',
                toLevelId: isFlow1to2 ? 'V2' : 'V1',
                label: '\\text{Charge flow}', // Always label flow direction
                arrowStyle: '->', // Always point high to low
                color: '#4daf4a', // Green for flow?
            });
        }
        diagram.setArrows(arrowData);
    }

    // --- Event Listener ---
    slider.addEventListener(
        'input',
        throttle((event) => {
            const deltaV = parseFloat(event.target.value);
            updateDemo(deltaV);
        }, throttleDuration)
    );

    // --- Initial Draw ---
    updateDemo(parseFloat(slider.value));
</script>
